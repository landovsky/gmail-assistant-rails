#!/usr/bin/env ruby

require_relative "../config/environment"
require "net/http"
require "json"

def usage
  puts <<~HELP
    Usage: bin/full-sync [OPTIONS]

    Trigger a full inbox sync (classifies all untagged emails).

    Options:
      --env ENV      Target environment: dev (default) or production
      --reset        Also wipe transient DB data before sync
      --user EMAIL   Sync a specific user only
      --help         Show this help message

    Production requires GMA_SERVER_ADMIN_USER and GMA_SERVER_ADMIN_PASSWORD env vars.
  HELP
  exit
end

usage if ARGV.include?("--help")

env = ARGV.index("--env") ? ARGV[ARGV.index("--env") + 1] : "dev"
reset = ARGV.include?("--reset")
user_email = ARGV.index("--user") ? ARGV[ARGV.index("--user") + 1] : nil

base_url = case env
when "production"
  "https://gmail.kopernici.cz"
when "dev"
  "http://localhost:3000"
else
  abort "Unknown environment: #{env}. Use 'dev' or 'production'."
end

if env == "production"
  admin_user = ENV["GMA_SERVER_ADMIN_USER"]
  admin_pass = ENV["GMA_SERVER_ADMIN_PASSWORD"]
  abort "Production requires GMA_SERVER_ADMIN_USER and GMA_SERVER_ADMIN_PASSWORD" unless admin_user && admin_pass

  if reset
    print "You are about to reset production data. Type 'yes' to confirm: "
    abort "Aborted." unless $stdin.gets&.chomp == "yes"
  end
end

# Health check
puts "Checking server health at #{base_url}..."
begin
  uri = URI("#{base_url}/api/health")
  response = Net::HTTP.get_response(uri)
  abort "Server health check failed: #{response.code}" unless response.code == "200"
  puts "Server is healthy."
rescue => e
  abort "Cannot reach server: #{e.message}"
end

def make_request(base_url, path, env, body = {})
  uri = URI("#{base_url}#{path}")
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = uri.scheme == "https"

  request = Net::HTTP::Post.new(uri.path, "Content-Type" => "application/json")
  request.body = body.to_json

  if env == "production"
    request.basic_auth(ENV["GMA_SERVER_ADMIN_USER"], ENV["GMA_SERVER_ADMIN_PASSWORD"])
  end

  http.request(request)
end

if reset
  puts "Resetting transient data..."
  response = make_request(base_url, "/api/reset", env)
  if response.code == "200"
    result = JSON.parse(response.body)
    puts "Reset complete: #{result}"
  else
    abort "Reset failed: #{response.code} #{response.body}"
  end
end

puts "Triggering full sync..."
body = {}
body[:user_email] = user_email if user_email

response = make_request(base_url, "/api/sync", env, body.merge(full: true))
if response.code.start_with?("2")
  result = JSON.parse(response.body)
  puts "Sync triggered: #{result}"
else
  abort "Sync failed: #{response.code} #{response.body}"
end

puts "Done."
